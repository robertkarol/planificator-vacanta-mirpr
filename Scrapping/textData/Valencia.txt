Madrid and Barcelona are Spain's premier cities, and you could easily spend a couple of weeks in each, especially if you were to add in day trips.
But few people have so long for their vacation, so you'll have to plan well to get the most into your limited time.
If you want to do your entire itinerary by train, take a look at the rail map of Spain which will give you prices and travel times for your trip.
Obviously, which city you can get a cheap flight to will probably dictate where you start, but, if you have a choice, go to Madrid. The capital takes a little longer to appreciate, so base yourself there and give it a bit more time.
Valencia is not what some people would call an 'essential' stop for your trip to Spain. It is a great weekend break in its own right: as the home of paella, it is a fantastic city to eat in, it has great beaches, and its old town feels a lot smaller than it is. But if you are visiting Madrid and Barcelona on one trip, you are probably a big city kinda person; Valencia will pale in comparison to the other two. On the other hand, if you're trying to break up your Madrid-Barcelona vacation with a smaller stop along the way, the country's third biggest city doesn't really fit that bill.
However, Valencia is worth a visit, particularly for the paella. As part of a Madrid and Barcelona trip, you could spend half a day there or, at most, stay the night and leave after breakfast.
Usually guided tours tend to merely depart from one city and guide you in the other.
If you would like a tour of both cities, consider booking a walking tour in the city where you start.
You can't spend much time in each city with such a short visit, so you'll need to stay in one city and do a day trip to the other.
Explore Madrid with a combination of guided tours and exploring by yourself.
Morning: Do a Madrid Walking Tour or take the Madrid Hop-On-Hop-Off Sightseeing Bus for an overview of the city.
Lunch Visit El Botin, the oldest continually functioning restaurant in the world and Hemingway's favorite.
Afternoon: Check out Madrid's Golden Triangle of Art Museum. Pick the one that most suits you.
Alternatively, take a half-day tour. You can still fit in a walking tour of Madrid or a visit to one of the big museums.
Evening: Tapas, perhaps? Either by exploring the area just south of Sol or on a Madrid Tapas Tour. Or perhaps see a flamenco show at one of several good flamenco tablaos in Madrid.
Morning: The high-speed AVE train from Madrid to Barcelona means that, yes, you can do a day trip to Barcelona. There are guided tours designed especially for this, but you can do the trip by yourself too.
Afternoon: The Barcelona hop-on-hop-off sightseeing bus will fulfill all of your transport needs for the day. It will take you up to Parc Guell and the Sagrada Familia, as well as into the downtown Gothic Quarter, Ramblas, and El Born areas.
Evening: Return to Madrid.
Though both Madrid and Barcelona warrant more than a day, a suggestion for your third day would be to go on a day trip from the capital, or even a half-day trip, and spend the rest of your day in Madrid.
For the options below, you'll want to stay in Barcelona and flip the itinerary around, visiting Madrid as a day trip, or going through the hassle of checking into hotels in both Madrid and Barcelona.
If you don't want to leave the city but want an experience that is different from the typical hustle of central Barcelona, head up to to Gracia, the village-like district on the other side of the Eixample area. There are also plenty of excellent Day Trips From Barcelona, with two trips that stick out as being particularly worth considering. These are in fact both half-day trips, which means you can spend the other half of the day checking out the city.
A Visit to Montserrat fantastical rock formations and a famous monastery await you after some gorgeous views on the rack railway and cable car. Visit by yourself or on a half-day tour, but we recommend combining it with a stop at the Gaudi Crypt and Colonia Guell.
The Dali Museum in Figueres: Salvador Dali is one of the world's most fun artists in the world, and that is well represented in his Disney-like museum, just a short ride by high-speed rail from Barcelona. Visit by yourself in a half day trip, or combine it with a visit to Girona with this Dali Museum and Girona Guided Tour.
You could also use your extra day to visit Valencia en route between the two larger cities. Either check your luggage at the train station and spend just the day in Valencia, or stay the night and leave in the morning. At the bottom of the page there is more on visiting Valencia.
Four days gives you long enough to split your time evenly between the two cities, meaning you don't need to choose between the options in the 2- and 3-day itineraries—you can do them all! Bear in mind, though, that 4 days is still not really enough time.
Where to Stay: Find a hotel in Madrid close to the train station for the first night, and transfer to Barcelona on the evening of the second night.
For more details on the individual parts of this itinerary, see above.
Day 1: Explore Madrid.
Day 2: Visit Toledo or El Escorial and the Valley of the Fallen in the morning and see more of Madrid in the afternoon. Transfer to Barcelona.
Day 3: Explore Barcelona.
Day 4: Visit the Dali museum in Figueres, or go to Montserrat Montserrat.
Alternatively, take a 4-Day Guided Tour of Barcelona and Valencia from Madrid, but bear in mind that there are no days in Madrid on this tour, so you'll need extra time to explore the capital by yourself.
A 6-day itinerary allows you to conveniently divide your trip into 3 days in each city. If you can only spare 5 days, then drop the extra day from either Madrid or Barcelona.
Most of this suggested itinerary is similar to the 4-day version, with 2 extra days.  This gives you the option of either spending more time in one of the two cities or adding in an extra stop between the two.
Alternatively, day 3 or 6 could be spent in Valencia.
For the days outside of Madrid, consider a 4-Day Guided Tour of Barcelona and Valencia from Madrid.
Suggestions for this day include:
Madrid and Valencia are connected by the high-speed AVE railway. The whole journey takes just over 90 minutes (sometimes a bit longer) and costs around 45€. But consider adding in Cuenca on the way (see below). 
How to Get to Valencia From Barcelona
The train route between Barcelona and Valencia isn't as quick as the Madrid-Valencia route, with journeys taking over three hours, sometimes a lot more.  
Stay the Night or Visit en Route? With 4.5 hours of train travel ahead of you, it might be tempting to stay the night in Valencia. However, it's preferable to travel from Valencia to Barcelona in the evening—say from 6pm until 9pm—and then get a late dinner in Barcelona, rather than waste your morning in transit.
What to Do in Valencia
Paella! The famous rice dish is at its best in Valencia. If you thought paella was a seafood dish, you'll be pleased to know paella valenciana is actually made with meat (while vegetarians will easily find a version for them too).
The old town area has a great small-town feel to it (but you'll get that in spades if you visit Gracia in Barcelona). 
There is also the Ciudad de Artes y Ciencias—a huge modern art and science exhibition complex—and the beach.
Consider these options if you do not want Valencia as your third stop:
San Sebastian or Bilbao: The Basque Country is an excellent place to visit. San Sebastian is renowned for its tapas (known locally as pintxos) while Bilbao is home to the Guggenheim museum. But, if you're already trying to cram big cities like Barcelona and Madrid into a short tour, adding one of these two is probably biting off more than you can chew. Choose somewhere smaller.
Logroño: This city has all of the gourmet food of San Sebastian, but it's cheaper and closer to Madrid and Barcelona. This would be my choice.
Seville: You can take the high-speed train down to Seville from Madrid and then fly to Barcelona. But again, this is a big city—do you really want to be adding it to an already hectic itinerary?
Zaragoza: This convenient stop is on the same train line as Madrid and Barcelona, but there's little to see apart from its two cathedrals.
Cuenca and Valencia: Visit Cuenca's stunning ravine and hanging houses en route from Madrid to Valencia; round off your day with paella near your hotel in Valencia; and head off to Barcelona the next day: Cuenca and Valencian paella is better than just Valencia.
